<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF Question Finder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen py-10">
  <h1 class="text-3xl font-bold mb-6 text-gray-800">ðŸ“˜ PDF Question Finder</h1>

  <div id="drop-zone" 
       class="w-96 h-40 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center rounded-lg bg-white cursor-pointer mb-4">
    <p class="text-gray-500 mb-2">Drag & Drop PDFs here</p>
    <p class="text-gray-400 text-sm">or click to select (max 10)</p>
    <input type="file" id="fileInput" multiple accept=".pdf" hidden>
    <div id="fileNames" class="text-sm text-gray-600 mt-2"></div>
  </div>

  <button id="uploadBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition mb-4">Upload & Analyze</button>
  <button id="downloadBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition mb-4">Download PDF</button>

  <div id="results" class="mt-8 w-2/3"></div>

<script>
  const dropZone = document.getElementById("drop-zone");
  const fileInput = document.getElementById("fileInput");
  const fileNamesDiv = document.getElementById("fileNames");
  const downloadBtn = document.getElementById("downloadBtn");
  let selectedFiles = [];
  let lastResults = [];

  dropZone.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) => {
    selectedFiles = Array.from(e.target.files);
    fileNamesDiv.innerHTML = selectedFiles.map(f => f.name).join("<br>");
  });

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("bg-blue-100");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("bg-blue-100");
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    selectedFiles = Array.from(e.dataTransfer.files);
    fileNamesDiv.innerHTML = selectedFiles.map(f => f.name).join("<br>");
    dropZone.classList.remove("bg-blue-100");
  });

  document.getElementById("uploadBtn").addEventListener("click", async () => {
    if (selectedFiles.length === 0) {
      alert("Please select at least one PDF file.");
      return;
    }

    let formData = new FormData();
    selectedFiles.forEach(f => formData.append("pdfs", f));

    const res = await fetch("/upload", { method: "POST", body: formData });
    const data = await res.json();
    lastResults = data;

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "<h2 class='text-xl font-semibold mb-4'>ðŸ“Œ Most Likely Repeated Questions</h2>";

    if (data.error) {
      resultsDiv.innerHTML += `<p class="text-red-500">${data.error}</p>`;
      return;
    }

    data.forEach((item, i) => {
      resultsDiv.innerHTML += `
        <div class="bg-white shadow p-4 rounded mb-3 flex justify-between items-center">
          <p class="font-medium text-gray-800">Q${i + 1}: ${item.question}</p>
          <span class="bg-green-200 text-green-800 px-2 py-1 rounded text-sm">Seen ${item.count} times</span>
        </div>
      `;
    });
  });

  downloadBtn.addEventListener("click", () => {
    if (!lastResults || lastResults.length === 0) {
      alert("No results to download!");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("ðŸ“˜ PDF Question Finder - Predicted Questions", 10, 15);

    doc.setFontSize(12);
    let y = 30;
    lastResults.forEach((item, i) => {
      const lines = doc.splitTextToSize(`Q${i+1}: ${item.question} (Seen ${item.count} times)`, 180);
      doc.text(lines, 10, y);
      y += lines.length * 7;
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
    });

    doc.save("Predicted_Questions.pdf");
  });
</script>
</body>
</html>
